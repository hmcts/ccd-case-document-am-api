version: 1.0-preview-1
steps:
  - id: pull-temurin-amd64
    cmd: >
      # pull amd64 Temurin Alpine and tag it where the Dockerfile expects a base
      docker pull --platform linux/amd64 eclipse-temurin:21-jdk-alpine &&
      docker tag eclipse-temurin:21-jdk-alpine hmctspublic.azurecr.io/base/java/linux/amd64:21-jdk-alpine
    when: ["-"]
    retries: 3
    retryDelay: 5

  - id: runtime-amd64
    build: >
      --pull
      --platform linux/amd64
      -t {{.Run.Registry}}/{{CI_IMAGE_TAG}}-amd64
      --build-arg PLATFORM=/linux/amd64
      .
    when:
      - pull-temurin-amd64
    retries: 3
    retryDelay: 5

  - id: pull-temurin-arm64
    cmd: >
      docker pull --platform linux/arm64 eclipse-temurin:21-jdk-alpine &&
      docker tag eclipse-temurin:21-jdk-alpine hmctspublic.azurecr.io/base/java/linux/arm64:21-jdk-alpine
    when:
      - pull-temurin-amd64
    retries: 3
    retryDelay: 5

  - id: runtime-arm64
    build: >
      --pull
      --platform linux/arm64/v8
      -t {{.Run.Registry}}/{{CI_IMAGE_TAG}}-arm64
      --build-arg PLATFORM=/linux/arm64
      .
    when:
      - pull-temurin-arm64
    retries: 3
    retryDelay: 5

  - id: push-images
    push:
      - "{{.Run.Registry}}/{{CI_IMAGE_TAG}}-amd64"
      - "{{.Run.Registry}}/{{CI_IMAGE_TAG}}-arm64"
    when:
      - runtime-amd64
      - runtime-arm64
    retries: 3
    retryDelay: 5

  - id: manifest-create
    cmd: >
      docker manifest create {{.Run.Registry}}/{{CI_IMAGE_TAG}} {{.Run.Registry}}/{{CI_IMAGE_TAG}}-amd64 {{.Run.Registry}}/{{CI_IMAGE_TAG}}-arm64
    when:
      - push-images
    retries: 3
    retryDelay: 5

  - id: manifest-push
    cmd: >
      docker manifest push --purge {{.Run.Registry}}/{{CI_IMAGE_TAG}}
    when:
      - manifest-create
    retries: 3
    retryDelay: 5
